<p-toast></p-toast>
<div class="dashboard-container">
  <!-- Header Stats -->
  <div class="stats-grid">
    <!-- WebSocket Status Indicator -->
    <div class="websocket-status" [ngClass]="{'connected': wsConnected, 'disconnected': !wsConnected}">
      <i class="pi" [ngClass]="wsConnected ? 'pi-wifi' : 'pi-wifi-off'"></i>
      <span>{{ wsConnected ? 'Real-time monitoring active' : 'Real-time monitoring disconnected' }}</span>
    </div>

    <div class="stat-card total">
      <div class="stat-icon">üñ®Ô∏è</div>
      <div class="stat-info">
        <h3>{{ dashboardStats.total }}</h3>
        <p>Total Printers</p>
      </div>
    </div>

    <div class="stat-card online">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-info">
        <h3>{{ dashboardStats.online }}</h3>
        <p>Online</p>
      </div>
    </div>

    <div class="stat-card offline">
      <div class="stat-icon">‚ùå</div>
      <div class="stat-info">
        <h3>{{ dashboardStats.offline }}</h3>
        <p>Offline</p>
      </div>
    </div>

    <div class="stat-card warning">
      <div class="stat-icon">‚ö†Ô∏è</div>
      <div class="stat-info">
        <h3>{{ dashboardStats.warning }}</h3>
        <p>Warning</p>
      </div>
    </div>

    <div class="stat-card laser">
      <div class="stat-icon">üñ§</div>
      <div class="stat-info">
        <h3>{{ dashboardStats.laser }}</h3>
        <p>Laser (Toner)</p>
      </div>
    </div>

    <div class="stat-card inkjet">
      <div class="stat-icon">üé®</div>
      <div class="stat-info">
        <h3>{{ dashboardStats.inkjet }}</h3>
        <p>Inkjet (Ink)</p>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="dashboard-content">
    <!-- Recent Alerts -->
    <div class="dashboard-section">
      <div class="section-header">
        <h2>Recent Alerts</h2>
        <div class="header-actions">
          <button pButton pRipple class="btn-ack-all" (click)="acknowledgeAllAlerts()" 
            [disabled]="!hasUnreadAlerts" title="Mark All as Read">
            <i class="pi pi-check-circle"></i> Ack All
          </button>
          <button pButton pRipple class="btn-refresh" (click)="refreshAlerts()" title="Refresh Alerts">
            Refresh
          </button>
          <button pButton pRipple class="btn-link" routerLink="/alerts">View All</button>
        </div>
      </div>

      <div class="alerts-list" *ngIf="alerts.length > 0; else noAlerts">
        <div class="alert-item" *ngFor="let alert of alerts" [ngClass]="getSeverityClass(alert.severity)">
          <div class="alert-icon">
            <i class="pi" [ngClass]="getSeverityIcon(alert.severity)"></i>
          </div>
          <div class="alert-content">
            <div class="alert-header">
              <h4>{{ alert.printerName || alert.printerId }}</h4>
              <span class="alert-severity">{{ alert.severity | titlecase }}</span>
            </div>
            <p>{{ alert.message }}</p>
            <div class="alert-meta">
              <small class="alert-time">{{ alert.createdAt | date:'short' }}</small>
              <span class="alert-status" [ngClass]="alert.isAcknowledged === 1 ? 'read' : 'unread'">
                {{ alert.isAcknowledged === 1 ? 'Read' : 'Unread' }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <ng-template #noAlerts>
        <div class="no-data">
          <i class="pi pi-info-circle"></i>
          <p>No recent alerts</p>
          <button pButton pRipple class="btn-check" (click)="refreshAlerts()">
            Check for Alerts
          </button>
        </div>
      </ng-template>
    </div>

    <!-- Printer Status Overview -->
    <div class="dashboard-section">
      <div class="section-header">
        <h2>Printer Status</h2>
        <div class="header-actions">
          <button pButton pRipple class="btn-refresh" (click)="refreshNow()" title="Refresh SNMP Data">
            Refresh
          </button>
          <button pButton pRipple class="btn-link" routerLink="/printers">View All</button>
        </div>
      </div>

      <div class="printers-grid" *ngIf="!isLoadingPrinters && printers.length > 0">
        <!-- Added (click) handler -->
        <div class="printer-card" *ngFor="let printer of printers.slice(0, 6)"
          [ngClass]="getStatusClass(printer.status)" (click)="showPrinterDetails(printer)" style="cursor: pointer;">
          <div class="printer-header">
            <h4>{{ printer.name }}</h4>
            <span class="status-badge">{{ printer.status }}</span>
          </div>
          <div class="printer-info">
            <p><strong>Model:</strong> {{ printer.model }}</p>
            <p><strong>Location:</strong> {{ printer.location }}</p>
            <p><strong>IP:</strong> {{ printer.ipAddress }}</p>
          </div>
          <div class="printer-stats" *ngIf="printer.status === 'online'">
            <div class="stat" *ngIf="printer.printerType === 'laser'">
              <span>Toner:</span>
              <div class="progress-bar">
                <div class="progress toner" [style.width.%]="printer.tonerLevel || 0"></div>
              </div>
              <span>{{ printer.tonerLevel || 0 }}%</span>
            </div>
            <div class="ink-stats" *ngIf="printer.printerType === 'inkjet' && printer.inkLevels">
              <span>Ink:</span>
              <div class="ink-grid">
                <div class="mini-ink" *ngIf="printer.inkLevels.cyan !== undefined">
                  <div class="mini-bar cyan" [style.--width]="printer.inkLevels.cyan + '%'"></div>
                  <small>C: {{ printer.inkLevels.cyan }}%</small>
                </div>
                <div class="mini-ink" *ngIf="printer.inkLevels.magenta !== undefined">
                  <div class="mini-bar magenta" [style.--width]="printer.inkLevels.magenta + '%'"></div>
                  <small>M: {{ printer.inkLevels.magenta }}%</small>
                </div>
                <div class="mini-ink" *ngIf="printer.inkLevels.yellow !== undefined">
                  <div class="mini-bar yellow" [style.--width]="printer.inkLevels.yellow + '%'"></div>
                  <small>Y: {{ printer.inkLevels.yellow }}%</small>
                </div>
                <div class="mini-ink" *ngIf="printer.inkLevels.black !== undefined">
                  <div class="mini-bar black" [style.--width]="printer.inkLevels.black + '%'"></div>
                  <small>K: {{ printer.inkLevels.black }}%</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="loading-printers" *ngIf="isLoadingPrinters">
        <p>Loading printers...</p>
      </div>

      <ng-template #noPrinters>
        <div class="no-data" *ngIf="!isLoadingPrinters">
          <p>No printers found</p>
          <button pButton pRipple class="btn-add-printer" routerLink="/printers">
            + Add Your First Printer
          </button>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Detailed Printer Dialog -->
  <p-dialog [(visible)]="displayDetailDialog" [header]="selectedPrinter ? selectedPrinter.name : 'Printer Details'"
    [modal]="true" [style]="{width: '60vw', minHeight: '400px'}" [draggable]="false" [resizable]="false">

    <!-- Loading State -->
    <div *ngIf="isLoadingDetails" class="loading-details">
      <div class="loading-content">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem; color: #007bff;"></i>
        <p>Loading printer details...</p>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="!isLoadingDetails && selectedPrinter && selectedPrinter.detailedInfo?.connectionStatus === 'Offline'" class="error-details">
      <div class="error-content">
        <i class="pi pi-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>
        <h3>Printer Offline</h3>
        <p>{{ selectedPrinter.detailedInfo?.errorMessage }}</p>
        <p><strong>Basic Info:</strong></p>
        <div class="basic-info">
          <p><strong>Name:</strong> {{ selectedPrinter.name }}</p>
          <p><strong>Model:</strong> {{ selectedPrinter.model }}</p>
          <p><strong>IP Address:</strong> {{ selectedPrinter.ipAddress }}</p>
          <p><strong>Location:</strong> {{ selectedPrinter.location }}</p>
        </div>
      </div>
    </div>

    <!-- Content when loaded and online -->
    <div *ngIf="!isLoadingDetails && selectedPrinter && selectedPrinter.detailedInfo && selectedPrinter.detailedInfo.connectionStatus !== 'Offline'" class="printer-detail-content">

      <p-accordion [multiple]="true">
        <!-- 1. Printer Information (Expanded by default) -->
        <p-accordionTab header="Printer Information" [selected]="true">
          <div class="detail-grid">
            <div class="detail-item">
              <label>Product Name</label>
              <span>{{ selectedPrinter.detailedInfo.productName || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <label>Printer Name</label>
              <span>{{ selectedPrinter.detailedInfo.printerName || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <label>Model Number</label>
              <span>{{ selectedPrinter.detailedInfo.modelNumber || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <label>Serial Number</label>
              <span>{{ selectedPrinter.detailedInfo.serialNumber || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <label>Engine Cycles</label>
              <span>{{ selectedPrinter.detailedInfo.engineCycles | number }}</span>
            </div>
          </div>
        </p-accordionTab>

        <!-- 2. Memory Information -->
        <p-accordionTab header="Memory Information">
          <div class="detail-grid">
            <div class="detail-item">
              <label>On Board Memory</label>
              <span>{{ selectedPrinter.detailedInfo.memory?.onBoard || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <label>Total Usable RAM</label>
              <span>{{ selectedPrinter.detailedInfo.memory?.totalUsable || 'N/A' }}</span>
            </div>
          </div>
        </p-accordionTab>

        <!-- 3. Event Log -->
        <p-accordionTab header="Event Log">
          <div class="detail-grid">
            <div class="detail-item">
              <label>Entries in Use</label>
              <span>{{ selectedPrinter.detailedInfo.eventLog?.entriesInUse || 0 }}</span>
            </div>
            <div class="detail-item">
              <label>Max Entries</label>
              <span>{{ selectedPrinter.detailedInfo.eventLog?.maxEntries || 'N/A' }}</span>
            </div>
          </div>
        </p-accordionTab>

        <!-- 4. Paper Trays and Options -->
        <p-accordionTab header="Paper Trays and Options">
          <div class="detail-grid">
            <div class="detail-item">
              <label>Default Paper Size</label>
              <span>{{ selectedPrinter.detailedInfo.trays?.defaultPaperSize || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <label>Tray 1 Size</label>
              <span>{{ selectedPrinter.detailedInfo.trays?.tray1Size || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <label>Tray 1 Type</label>
              <span>{{ selectedPrinter.detailedInfo.trays?.tray1Type || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <label>Tray 2 Size</label>
              <span>{{ selectedPrinter.detailedInfo.trays?.tray2Size || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <label>Tray 2 Type</label>
              <span>{{ selectedPrinter.detailedInfo.trays?.tray2Type || 'N/A' }}</span>
            </div>
          </div>
        </p-accordionTab>

        <!-- 5. Ink/Toner Information -->
        <p-accordionTab
          [header]="(selectedPrinter.printerType === 'inkjet') ? 'Ink Tank Information' : 'Cartridge Information'">
          <div class="detail-grid">
            <div class="detail-item">
              <label>Supply Level</label>
              <span [ngClass]="{'status-warning': selectedPrinter.detailedInfo.cartridge?.supplyLevel === 'Low'}">
                {{ selectedPrinter.detailedInfo.cartridge?.supplyLevel || 'N/A' }}
              </span>
            </div>
            <div class="detail-item" *ngIf="selectedPrinter.printerType === 'inkjet'">
              <label>Ink Tank Serial</label>
              <span>{{ selectedPrinter.detailedInfo.cartridge?.serialNumber || 'N/A' }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedPrinter.printerType === 'laser'">
              <label>Cartridge Serial</label>
              <span>{{ selectedPrinter.detailedInfo.cartridge?.serialNumber || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <label>Pages Printed</label>
              <span>{{ selectedPrinter.detailedInfo.cartridge?.pagesPrinted | number }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedPrinter.printerType === 'inkjet'">
              <label>Tank Install Date</label>
              <span>{{ selectedPrinter.detailedInfo.cartridge?.firstInstallDate || 'N/A' }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedPrinter.printerType === 'laser'">
              <label>Cartridge Install Date</label>
              <span>{{ selectedPrinter.detailedInfo.cartridge?.firstInstallDate || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <label>Last Used Date</label>
              <span>{{ selectedPrinter.detailedInfo.cartridge?.lastUsedDate || 'N/A' }}</span>
            </div>
          </div>
        </p-accordionTab>
      </p-accordion>
    </div>

    <!-- Footer with close button -->
    <ng-template pTemplate="footer">
      <button pButton pRipple label="Close" icon="pi pi-times" class="p-button-text" (click)="displayDetailDialog = false"></button>
    </ng-template>
  </p-dialog>
</div>